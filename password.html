<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #7c4dff;
            --secondary-color: #651fff;
            --background-color: #f5f5f5;
            --card-color: #ffffff;
            --text-color: #333333;
            --secondary-text: #757575;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 480px;
            margin: 0 auto;
            width: 100%;
            background-color: var(--card-color);
            box-shadow: var(--shadow);
            overflow: hidden;
            position: relative;
        }

        /* Header Styles */
        .header {
            padding: 16px;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 20px;
            font-weight: 500;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* Section Styles */
        .section {
            padding: 16px;
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        }

        .section-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 16px;
            color: var(--primary-color);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--secondary-text);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Password Generator Styles */
        .password-display {
            position: relative;
            margin-bottom: 16px;
        }

        .password-field {
            padding-right: 40px;
            font-family: monospace;
            letter-spacing: 1px;
        }

        .copy-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 16px;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .slider {
            flex: 1;
            -webkit-appearance: none;
            height: 4px;
            background: #e0e0e0;
            border-radius: 5px;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
        }

        .slider-value {
            min-width: 30px;
            text-align: center;
            font-weight: 500;
        }

        .options-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .option-check {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .option-check input[type="checkbox"] {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            position: relative;
        }

        .option-check input[type="checkbox"]:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .option-check input[type="checkbox"]:checked::after {
            content: '✓';
            color: white;
            position: absolute;
            font-size: 12px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Button Styles */
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
            text-align: center;
        }

        .btn:hover {
            background-color: var(--secondary-color);
        }

        .btn-block {
            display: block;
            width: 100%;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background-color: rgba(124, 77, 255, 0.1);
        }

        /* Saved Passwords Styles */
        .saved-passwords {
            margin-top: 24px;
        }

        .password-item {
            padding: 12px;
            border-radius: 8px;
            background-color: #f9f9f9;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .password-item-name {
            font-weight: 500;
        }

        .password-item-value {
            font-family: monospace;
            color: var(--secondary-text);
            margin: 4px 0;
        }

        .password-actions {
            display: flex;
            gap: 8px;
        }

        .password-action-btn {
            background: none;
            border: none;
            color: var(--secondary-text);
            cursor: pointer;
            font-size: 14px;
            padding: 4px;
        }

        /* Navigation Bar Styles */
        .nav-bar {
            display: flex;
            background-color: white;
            padding: 12px 0;
            border-top: 1px solid #e0e0e0;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--secondary-text);
            text-decoration: none;
            font-size: 12px;
            padding: 8px 0;
            cursor: pointer;
        }

        .nav-item i {
            font-size: 20px;
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        /* Profile Styles */
        .profile-info {
            text-align: center;
            padding: 24px 0;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin: 0 auto 16px;
        }

        .profile-name {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .profile-email {
            color: var(--secondary-text);
            font-size: 14px;
        }

        /* Auth Forms */
        .auth-container {
            padding: 24px 16px;
        }

        .auth-title {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 24px;
            text-align: center;
        }

        .auth-switch {
            text-align: center;
            margin-top: 24px;
            font-size: 14px;
            color: var(--secondary-text);
        }

        .auth-switch a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }

        /* Toasts/Alerts */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 24px;
            font-size: 14px;
            z-index: 1000;
            display: none;
        }

        /* Screens */
        .screen {
            display: none;
            height: 100%;
            flex-direction: column;
        }

        .screen.active {
            display: flex;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Password Generator Screen -->
        <div class="screen active" id="generator-screen">
            <div class="header">
                <h1>Password Generator</h1>
                <div id="login-status"></div>
            </div>
            <div class="main-content">
                <div class="section">
                    <div class="section-title">Generate Password</div>
                    <div class="password-display">
                        <input type="text" class="form-control password-field" id="password-output" readonly>
                        <button class="copy-btn" id="copy-password"><i class="fas fa-copy"></i></button>
                    </div>
                    <div class="form-group">
                        <div class="slider-container">
                            <label for="password-length">Length:</label>
                            <input type="range" class="slider" id="password-length" min="8" max="32" value="16">
                            <span class="slider-value" id="length-value">16</span>
                        </div>
                    </div>
                    <div class="options-container">
                        <div class="option-check">
                            <input type="checkbox" id="uppercase" checked>
                            <label for="uppercase">Uppercase</label>
                        </div>
                        <div class="option-check">
                            <input type="checkbox" id="lowercase" checked>
                            <label for="lowercase">Lowercase</label>
                        </div>
                        <div class="option-check">
                            <input type="checkbox" id="numbers" checked>
                            <label for="numbers">Numbers</label>
                        </div>
                        <div class="option-check">
                            <input type="checkbox" id="symbols">
                            <label for="symbols">Symbols</label>
                        </div>
                    </div>
                    <button class="btn btn-block" id="generate-btn">Generate Password</button>
                    <div class="form-group" id="save-password-form" style="display: none; margin-top: 16px;">
                        <label for="password-name">Save this password for:</label>
                        <input type="text" class="form-control" id="password-name" placeholder="e.g., Facebook, Gmail">
                        <button class="btn btn-block" id="save-password-btn" style="margin-top: 12px;">Save Password</button>
                    </div>
                </div>

                <div class="saved-passwords" id="saved-passwords-container" style="display: none;">
                    <div class="section-title">Saved Passwords</div>
                    <div id="saved-passwords-list"></div>
                </div>
            </div>
            <div class="nav-bar">
                <div class="nav-item active" data-screen="generator-screen">
                    <i class="fas fa-key"></i>
                    <span>Generate</span>
                </div>
                <div class="nav-item" data-screen="profile-screen">
                    <i class="fas fa-user"></i>
                    <span>Profile</span>
                </div>
            </div>
        </div>

        <!-- Profile Screen -->
        <div class="screen" id="profile-screen">
            <div class="header">
                <h1>Profile</h1>
            </div>
            <div class="main-content">
                <!-- Logged In View -->
                <div id="profile-logged-in" style="display: none;">
                    <div class="section">
                        <div class="profile-info">
                            <div class="profile-avatar" id="profile-avatar"></div>
                            <div class="profile-name" id="profile-name"></div>
                            <div class="profile-email" id="profile-email"></div>
                        </div>
                        <div style="display: flex; gap: 12px; margin-top: 16px;">
                            <button class="btn btn-block btn-outline" id="change-password-btn">Change Password</button>
                            <button class="btn btn-block" id="logout-btn">Log Out</button>
                        </div>
                    </div>
                </div>

                <!-- Login Form -->
                <div id="login-form" class="auth-container">
                    <h2 class="auth-title">Login</h2>
                    <div class="form-group">
                        <label for="login-email">Email</label>
                        <input type="email" class="form-control" id="login-email" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <input type="password" class="form-control" id="login-password" placeholder="Enter your password">
                    </div>
                    <button class="btn btn-block" id="login-btn">Login</button>
                    <div class="auth-switch">
                        Don't have an account? <a href="#" id="show-signup">Sign up</a>
                    </div>
                    <div class="auth-switch">
                        <a href="#" id="show-reset">Forgot password?</a>
                    </div>
                </div>

                <!-- Signup Form -->
                <div id="signup-form" class="auth-container" style="display: none;">
                    <h2 class="auth-title">Create Account</h2>
                    <div class="form-group">
                        <label for="signup-email">Email</label>
                        <input type="email" class="form-control" id="signup-email" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="signup-password">Password</label>
                        <input type="password" class="form-control" id="signup-password" placeholder="Create a password">
                    </div>
                    <div class="form-group">
                        <label for="signup-name">Full Name</label>
                        <input type="text" class="form-control" id="signup-name" placeholder="Enter your name">
                    </div>
                    <button class="btn btn-block" id="signup-btn">Sign Up</button>
                    <div class="auth-switch">
                        Already have an account? <a href="#" id="show-login">Login</a>
                    </div>
                </div>

                <!-- Reset Password Form -->
                <div id="reset-form" class="auth-container" style="display: none;">
                    <h2 class="auth-title">Reset Password</h2>
                    <div class="form-group">
                        <label for="reset-email">Email</label>
                        <input type="email" class="form-control" id="reset-email" placeholder="Enter your email">
                    </div>
                    <button class="btn btn-block" id="reset-btn">Send Reset Link</button>
                    <div class="auth-switch">
                        Remember your password? <a href="#" id="back-to-login">Login</a>
                    </div>
                </div>

                <!-- Change Password Form -->
                <div id="change-password-form" class="auth-container" style="display: none;">
                    <h2 class="auth-title">Change Password</h2>
                    <div class="form-group">
                        <label for="current-password">Current Password</label>
                        <input type="password" class="form-control" id="current-password" placeholder="Enter current password">
                    </div>
                    <div class="form-group">
                        <label for="new-password">New Password</label>
                        <input type="password" class="form-control" id="new-password" placeholder="Enter new password">
                    </div>
                    <button class="btn btn-block" id="change-password-submit">Update Password</button>
                    <div class="auth-switch">
                        <a href="#" id="back-to-profile">Back to Profile</a>
                    </div>
                </div>
            </div>
            <div class="nav-bar">
                <div class="nav-item" data-screen="generator-screen">
                    <i class="fas fa-key"></i>
                    <span>Generate</span>
                </div>
                <div class="nav-item active" data-screen="profile-screen">
                    <i class="fas fa-user"></i>
                    <span>Profile</span>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast-message"></div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // DOM Elements
        const passwordOutput = document.getElementById('password-output');
        const passwordLength = document.getElementById('password-length');
        const lengthValue = document.getElementById('length-value');
        const uppercase = document.getElementById('uppercase');
        const lowercase = document.getElementById('lowercase');
        const numbers = document.getElementById('numbers');
        const symbols = document.getElementById('symbols');
        const generateBtn = document.getElementById('generate-btn');
        const copyPasswordBtn = document.getElementById('copy-password');
        const savePasswordForm = document.getElementById('save-password-form');
        const passwordName = document.getElementById('password-name');
        const savePasswordBtn = document.getElementById('save-password-btn');
        const savedPasswordsContainer = document.getElementById('saved-passwords-container');
        const savedPasswordsList = document.getElementById('saved-passwords-list');
        const loginStatus = document.getElementById('login-status');

        // Auth Elements
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const resetForm = document.getElementById('reset-form');
        const changePasswordForm = document.getElementById('change-password-form');
        const profileLoggedIn = document.getElementById('profile-logged-in');
        const profileAvatar = document.getElementById('profile-avatar');
        const profileName = document.getElementById('profile-name');
        const profileEmail = document.getElementById('profile-email');

        // Toast
        const toast = document.getElementById('toast-message');

        // Current user
        let currentUser = null;
        let savedPasswords = [];
        const MAX_SAVED_PASSWORDS = 5;

        // Initialize the app
        async function initApp() {
            // Check if user is logged in
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                updateUserInterface();
                fetchSavedPasswords();
            }

            // Generate initial password
            generatePassword();
        }

        // Generate password based on selected criteria
        function generatePassword() {
            const length = passwordLength.value;
            const hasUppercase = uppercase.checked;
            const hasLowercase = lowercase.checked;
            const hasNumbers = numbers.checked;
            const hasSymbols = symbols.checked;

            // Ensure at least one character type is selected
            if (!hasUppercase && !hasLowercase && !hasNumbers && !hasSymbols) {
                lowercase.checked = true;
            }

            let charset = '';
            if (hasUppercase) charset += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            if (hasLowercase) charset += 'abcdefghijklmnopqrstuvwxyz';
            if (hasNumbers) charset += '0123456789';
            if (hasSymbols) charset += '!@#$%^&*()_+~`|}{[]:;?><,./-=';

            let password = '';
            for (let i = 0; i < length; i++) {
                const randomIndex = Math.floor(Math.random() * charset.length);
                password += charset[randomIndex];
            }

            passwordOutput.value = password;

            // Show save form if user is logged in
            if (currentUser) {
                savePasswordForm.style.display = 'block';
            }
        }

        // Copy password to clipboard
        function copyPassword() {
            passwordOutput.select();
            document.execCommand('copy');
            
            // Show toast message
            showToast('Password copied to clipboard');
        }

        // Show toast message
        function showToast(message) {
            toast.textContent = message;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        // Save password to Supabase
        async function savePassword() {
            if (!currentUser) {
                showToast('Please login to save passwords');
                return;
            }

            const name = passwordName.value.trim();
            const password = passwordOutput.value;

            if (!name) {
                showToast('Please enter a name for this password');
                return;
            }

            if (savedPasswords.length >= MAX_SAVED_PASSWORDS) {
                showToast(`You can only save up to ${MAX_SAVED_PASSWORDS} passwords`);
                return;
            }

            // Encrypt password before storing
            const encryptedPassword = CryptoJS.AES.encrypt(password, currentUser.id).toString();

            const { data, error } = await supabase
                .from('passwords')
                .insert([
                    { 
                        user_id: currentUser.id, 
                        name, 
                        password: encryptedPassword
                    }
                ]);

            if (error) {
                showToast('Error saving password');
                console.error(error);
                return;
            }

            showToast('Password saved successfully');
            passwordName.value = '';
            fetchSavedPasswords();
        }

        // Fetch saved passwords from Supabase
        async function fetchSavedPasswords() {
            if (!currentUser) return;

            const { data, error } = await supabase
                .from('passwords')
                .select('*')
                .eq('user_id', currentUser.id);

            if (error) {
                console.error(error);
                return;
            }

            savedPasswords = data || [];
            renderSavedPasswords();
        }

        // Render saved passwords
        function renderSavedPasswords() {
            if (!currentUser || savedPasswords.length === 0) {
                savedPasswordsContainer.style.display = 'none';
                return;
            }

            savedPasswordsContainer.style.display = 'block';
            savedPasswordsList.innerHTML = '';

            savedPasswords.forEach(item => {
                // Decrypt password
                const decryptedPassword = CryptoJS.AES.decrypt(item.password, currentUser.id).toString(CryptoJS.enc.Utf8);
                
                // Create password item element
                const passwordItem = document.createElement('div');
                passwordItem.className = 'password-item';
                passwordItem.innerHTML = `
                    <div>
                        <div class="password-item-name">${item.name}</div>
                        <div class="password-item-value">••••••••••</div>
                    </div>
                    <div class="password-actions">
                        <button class="password-action-btn view-password" data-id="${item.id}" data-password="${decryptedPassword}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="password-action-btn copy-saved" data-password="${decryptedPassword}">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="password-action-btn delete-password" data-id="${item.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;

                savedPasswordsList.appendChild(passwordItem);

                // Add event listeners
                const viewBtn = passwordItem.querySelector('.view-password');
                const copyBtn = passwordItem.querySelector('.copy-saved');
                const deleteBtn = passwordItem.querySelector('.delete-password');

                viewBtn.addEventListener('click', function() {
                    const passwordValueElem = this.parentElement.parentElement.querySelector('.password-item-value');
                    const isHidden = passwordValueElem.textContent === '••••••••••';

                    if (isHidden) {
                        passwordValueElem.textContent = this.dataset.password;
                        this.querySelector('i').className = 'fas fa-eye-slash';
                    } else {
                        passwordValueElem.textContent = '••••••••••';
                        this.querySelector('i').className = 'fas fa-eye';
                    }
                });

                copyBtn.addEventListener('click', function() {
                    const password = this.dataset.password;
                    navigator.clipboard.writeText(password).then(() => {
                        showToast('Password copied to clipboard');
                    });
                });

                deleteBtn.addEventListener('click', function() {
                    deletePassword(this.dataset.id);
                });
            });
        }

        // Delete password
        async function deletePassword(id) {
            const { error } = await supabase
                .from('passwords')
                .delete()
                .eq('id', id);

            if (error) {
                showToast('Error deleting password');
                console.error(error);
                return;
            }

            showToast('Password deleted successfully');
            fetchSavedPasswords();
        }

        // Authentication functions
        async function login(email, password) {
            const { data, error } = await supabase.auth.signInWithPassword({
                email,
                password
            });

            if (error) {
                showToast(error.message);
                return false;
            }

            currentUser = data.user;
            updateUserInterface();
            fetchSavedPasswords();
            return true;
        }

        async function signup(email, password, name) {
            const { data, error } = await supabase.auth.signUp({
                email,
                password,
                options: {
                    data: {
                        full_name: name
                    }
                }
            });

            if (error) {
                showToast(error.message);
                return false;
            }

            showToast('Verification email sent! Please check your inbox');
            return true;
        }

        async function resetPassword(email) {
            const { error } = await supabase.auth.resetPasswordForEmail(email, {
                redirectTo: window.location.origin
            });

            if (error) {
                showToast(error.message);
                return false;
            }

            showToast('Password reset email sent');
            return true;
        }

        async function changePassword(currentPassword, newPassword) {
            // First verify current password
            const { error: verifyError } = await supabase.auth.signInWithPassword({
                email: currentUser.email,
                password: currentPassword
            });

            if (verifyError) {
                showToast('Current password is incorrect');
                return false;
            }

            const { error } = await supabase.auth.updateUser({
                password: newPassword
            });

            if (error) {
                showToast(error.message);
                return false;
            }

            showToast('Password updated successfully');
            return true;
        }

        async function logout() {
            const { error } = await supabase.auth.signOut();
            
            if (error) {
                showToast(error.message);
                return;
            }

            currentUser = null;
            updateUserInterface();
            savedPasswords = [];
            renderSavedPasswords();
        }

        // Update UI based on authentication state
        function updateUserInterface() {
            if (currentUser) {
                // Update login status
                loginStatus.innerHTML = `<i class="fas fa-user-check" style="color: white;"></i>`;
                
                // Show save password form
                savePasswordForm.style.display = 'block';
                
                // Update profile screen
                loginForm.style.display = 'none';
                signupForm.style.display = 'none';
                resetForm.style.display = 'none';
                changePasswordForm.style.display = 'none';
                profileLoggedIn.style.display = 'block';
                
                // Update profile info
                const userMetadata = currentUser.user_metadata || {};